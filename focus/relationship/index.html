<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relationship - Connection Cadence & Repair Playbook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .bg-primary { background: linear-gradient(135deg, #1a3b2e, #0f2419); }
        .bg-accent { background-color: #d4af37; }
        .text-accent { color: #d4af37; }
        .border-accent { border-color: #d4af37; }
        
        .card {
            background: rgba(212, 175, 55, 0.08);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 16px;
            padding: 24px;
            margin: 16px 0;
            transition: all 0.3s ease;
        }
        
        .contact-card {
            background: rgba(26, 59, 46, 0.6);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .contact-card:hover {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }
        
        .nav-btn {
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .nav-btn.active {
            background: linear-gradient(135deg, #d4af37, #f4d03f);
            color: #000;
        }
        
        .nav-btn:not(.active) {
            background: transparent;
            color: #d4af37;
            border: 2px solid rgba(212, 175, 55, 0.4);
        }
        
        .tier-chip {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }
        
        .tier-inner { background: #4ade80; color: #000; }
        .tier-close { background: #3b82f6; color: white; }
        .tier-regular { background: #f59e0b; color: #000; }
        .tier-occasional { background: #6b7280; color: white; }
        
        .overdue {
            background: rgba(239, 68, 68, 0.2) !important;
            border-color: #ef4444 !important;
        }
        
        .due-soon {
            background: rgba(245, 158, 11, 0.2) !important;
            border-color: #f59e0b !important;
        }
        
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-content {
            background: #1a3b2e;
            border: 2px solid #d4af37;
            border-radius: 16px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #d4af37;
            color: #000;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 3000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .floating-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d4af37, #f4d03f);
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .floating-btn:hover {
            transform: scale(1.1);
        }
        
        .voice-listening {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3) !important;
        }
        
        .repair-step {
            background: rgba(26, 59, 46, 0.4);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            padding: 16px;
            margin: 8px 0;
        }
        
        .repair-step.completed {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .breathing-circle {
            width: 200px;
            height: 200px;
            border: 6px solid #d4af37;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            transition: transform 4s ease-in-out;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.15), transparent);
        }
        
        .breathing-circle.inhale { transform: scale(1.3); }
        .breathing-circle.exhale { transform: scale(1); }
        
        .phrase-card {
            background: rgba(26, 59, 46, 0.4);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 6px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .phrase-card:hover {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }
    </style>
</head>
<body class="bg-primary min-h-screen text-white">
    <!-- Header -->
    <header class="p-6 text-center border-b border-accent">
        <h1 class="text-4xl font-bold text-accent mb-2">ü§ù Relationship</h1>
        <p class="text-lg text-gray-300 mb-4">Connection Cadence & Repair Playbook</p>
        
        <!-- Quick Stats -->
        <div class="flex justify-center items-center gap-8 flex-wrap">
            <div class="text-center">
                <div class="text-2xl font-bold text-accent" id="connectionStreak">0</div>
                <div class="text-sm text-gray-400">Connection Streak</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-accent" id="totalContacts">0</div>
                <div class="text-sm text-gray-400">Total Contacts</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-accent" id="overdueContacts">0</div>
                <div class="text-sm text-gray-400">Overdue</div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="p-4 flex justify-center gap-3 flex-wrap">
        <button onclick="showScreen('contacts')" id="contactsBtn" class="nav-btn active">üë• Contacts</button>
        <button onclick="showScreen('reminders')" id="remindersBtn" class="nav-btn">‚è∞ Reminders</button>
        <button onclick="showScreen('repair')" id="repairBtn" class="nav-btn">üîß Repair</button>
        <button onclick="showScreen('vocabulary')" id="vocabularyBtn" class="nav-btn">üí¨ Vocabulary</button>
        <button onclick="showScreen('breathing')" id="breathingBtn" class="nav-btn">üå¨Ô∏è Reset</button>
    </nav>

    <!-- Floating Quick Add Button -->
    <div onclick="showQuickAdd()" class="floating-btn" title="Quick Add">+</div>

    <!-- Contacts Screen -->
    <div id="contactsScreen" class="screen p-6">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-accent">üë• Contacts</h2>
                <button onclick="showAddContact()" class="bg-accent text-black px-6 py-3 rounded-lg font-bold">
                    ‚ûï Add Contact
                </button>
            </div>

            <!-- Search -->
            <div class="card">
                <input type="text" id="contactSearch" placeholder="Search contacts..." 
                       oninput="filterContacts()" 
                       class="w-full p-3 rounded-lg bg-gray-800 border border-accent text-white">
            </div>

            <!-- Contacts List -->
            <div id="contactsList" class="space-y-4">
                <!-- Contacts will be populated here -->
            </div>
        </div>
    </div>

    <!-- Reminders Screen -->
    <div id="remindersScreen" class="screen hidden p-6">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-3xl font-bold text-accent text-center mb-8">‚è∞ Connection Reminders</h2>
            
            <!-- Today's Reminders -->
            <div class="card">
                <h3 class="text-xl font-bold text-accent mb-4">üìÖ Today's Connections</h3>
                <div id="todayReminders" class="space-y-3">
                    <!-- Today's reminders will be populated here -->
                </div>
            </div>

            <!-- Overdue Connections -->
            <div class="card">
                <h3 class="text-xl font-bold text-accent mb-4">‚ö†Ô∏è Overdue Connections</h3>
                <div id="overdueReminders" class="space-y-3">
                    <!-- Overdue reminders will be populated here -->
                </div>
            </div>

            <!-- Recent Connections -->
            <div class="card">
                <h3 class="text-xl font-bold text-accent mb-4">üìã Recent Connections</h3>
                <div id="recentConnections" class="space-y-3 max-h-64 overflow-y-auto">
                    <!-- Recent connections will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Repair Playbook Screen -->
    <div id="repairScreen" class="screen hidden p-6">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-3xl font-bold text-accent text-center mb-8">üîß Repair Playbook</h2>
            
            <!-- Active Repair Session -->
            <div id="activeRepair" class="card hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-accent">Current Repair Session</h3>
                    <button onclick="endRepairSession()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm">
                        End Session
                    </button>
                </div>
                
                <div class="mb-4">
                    <div class="text-white font-semibold">Repairing with: <span id="repairContactName" class="text-accent"></span></div>
                    <div class="text-gray-400 text-sm">Issue: <span id="repairIssue"></span></div>
                </div>
                
                <div id="repairSteps" class="space-y-4">
                    <!-- Repair steps will be populated here -->
                </div>
                
                <div class="mt-6">
                    <button onclick="completeRepairSession()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold">
                        ‚úÖ Complete Repair
                    </button>
                </div>
            </div>

            <!-- Start New Repair -->
            <div id="newRepair" class="card">
                <h3 class="text-xl font-bold text-accent mb-4">üÜï Start New Repair</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-white font-semibold mb-2">Select Contact</label>
                        <select id="repairContact" class="w-full p-3 rounded-lg bg-gray-800 border border-accent text-white">
                            <option value="">Choose contact...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-white font-semibold mb-2">Issue Type</label>
                        <select id="issueType" class="w-full p-3 rounded-lg bg-gray-800 border border-accent text-white">
                            <option value="misunderstanding">Misunderstanding</option>
                            <option value="conflict">Conflict/Argument</option>
                            <option value="hurt-feelings">Hurt Feelings</option>
                            <option value="boundary">Boundary Issue</option>
                            <option value="neglect">Relationship Neglect</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-white font-semibold mb-2">Describe the Issue</label>
                    <button onclick="startVoiceInput('issueDescription', this)" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm mb-2">
                        üé§ Voice
                    </button>
                    <textarea id="issueDescription" placeholder="What happened? What needs to be repaired?" 
                              class="w-full h-24 p-3 rounded-lg bg-gray-800 border border-accent text-white resize-none"></textarea>
                </div>
                
                <button onclick="startRepairSession()" class="bg-accent text-black px-6 py-3 rounded-lg font-bold">
                    üîß Start Repair Process
                </button>
            </div>

            <!-- Repair History -->
            <div class="card">
                <h3 class="text-xl font-bold text-accent mb-4">üìö Repair History</h3>
                <div id="repairHistory" class="space-y-3 max-h-64 overflow-y-auto">
                    <!-- Repair history will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Vocabulary Screen -->
    <div id="vocabularyScreen" class="screen hidden p-6">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-3xl font-bold text-accent text-center mb-8">üí¨ Communication Vocabulary</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Empathy Phrases -->
                <div class="card">
                    <h3 class="text-lg font-bold text-accent mb-4">‚ù§Ô∏è Empathy & Understanding</h3>
                    <div id="empathyPhrases" class="space-y-2 max-h-80 overflow-y-auto mb-4">
                        <!-- Phrases will be populated here -->
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="newEmpathyPhrase" placeholder="Add empathy phrase..." 
                               class="flex-1 p-2 rounded bg-gray-800 border border-accent text-white text-sm">
                        <button onclick="addEmpathyPhrase()" class="bg-accent text-black px-3 py-2 rounded font-bold text-sm">
                            Add
                        </button>
                    </div>
                </div>

                <!-- Boundary Phrases -->
                <div class="card">
                    <h3 class="text-lg font-bold text-accent mb-4">üõ°Ô∏è Healthy Boundaries</h3>
                    <div id="boundaryPhrases" class="space-y-2 max-h-80 overflow-y-auto mb-4">
                        <!-- Phrases will be populated here -->
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="newBoundaryPhrase" placeholder="Add boundary phrase..." 
                               class="flex-1 p-2 rounded bg-gray-800 border border-accent text-white text-sm">
                        <button onclick="addBoundaryPhrase()" class="bg-accent text-black px-3 py-2 rounded font-bold text-sm">
                            Add
                        </button>
                    </div>
                </div>

                <!-- Repair Phrases -->
                <div class="card">
                    <h3 class="text-lg font-bold text-accent mb-4">üîß Repair & Reconciliation</h3>
                    <div id="repairPhrases" class="space-y-2 max-h-80 overflow-y-auto mb-4">
                        <!-- Phrases will be populated here -->
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="newRepairPhrase" placeholder="Add repair phrase..." 
                               class="flex-1 p-2 rounded bg-gray-800 border border-accent text-white text-sm">
                        <button onclick="addRepairPhrase()" class="bg-accent text-black px-3 py-2 rounded font-bold text-sm">
                            Add
                        </button>
                    </div>
                </div>

                <!-- Connection Phrases -->
                <div class="card">
                    <h3 class="text-lg font-bold text-accent mb-4">ü§ù Connection & Appreciation</h3>
                    <div id="connectionPhrases" class="space-y-2 max-h-80 overflow-y-auto mb-4">
                        <!-- Phrases will be populated here -->
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="newConnectionPhrase" placeholder="Add connection phrase..." 
                               class="flex-1 p-2 rounded bg-gray-800 border border-accent text-white text-sm">
                        <button onclick="addConnectionPhrase()" class="bg-accent text-black px-3 py-2 rounded font-bold text-sm">
                            Add
                        </button>
                    </div>
                </div>
            </div>

            <!-- Call Notes -->
            <div class="card">
                <h3 class="text-xl font-bold text-accent mb-4">üìû Quick Call Notes</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-white font-semibold mb-2">Contact</label>
                        <select id="callContact" class="w-full p-3 rounded-lg bg-gray-800 border border-accent text-white">
                            <option value="">Select contact...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-white font-semibold mb-2">Call Type</label>
                        <select id="callType" class="w-full p-3 rounded-lg bg-gray-800 border border-accent text-white">
                            <option value="check-in">Check-in</option>
                            <option value="important">Important Discussion</option>
                            <option value="repair">Repair Conversation</option>
                            <option value="celebration">Celebration</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-white font-semibold mb-2">Call Notes</label>
                    <button onclick="startVoiceInput('callNotes', this)" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm mb-2">
                        üé§ Voice Notes
                    </button>
                    <textarea id="callNotes" placeholder="Key points, follow-ups, insights..." 
                              class="w-full h-24 p-3 rounded-lg bg-gray-800 border border-accent text-white resize-none"></textarea>
                </div>
                
                <button onclick="saveCallNotes()" class="bg-accent text-black px-6 py-3 rounded-lg font-bold">
                    üíæ Save Call Notes
                </button>
            </div>
        </div>
    </div>

    <!-- Breathing Reset Screen -->
    <div id="breathingScreen" class="screen hidden p-6">
        <div class="max-w-2xl mx-auto text-center">
            <h2 class="text-3xl font-bold text-accent mb-8">üå¨Ô∏è 25-Minute Breathing Reset</h2>
            
            <!-- Breathing Interface -->
            <div class="card">
                <div class="text-center mb-6">
                    <div class="text-5xl font-bold text-accent mb-4" id="breathingTimer">25:00</div>
                    <div class="text-lg text-gray-300 mb-6" id="breathingInstruction">Prepare for your breathing reset session</div>
                </div>
                
                <!-- Breathing Visual -->
                <div class="breathing-circle mb-8" id="breathingCircle">
                    <div class="text-accent font-bold text-xl" id="breathingCue">Ready</div>
                </div>
                
                <!-- Controls -->
                <div class="flex justify-center gap-4 mb-6">
                    <button onclick="startBreathingReset()" id="startBreathingBtn" 
                            class="bg-accent text-black px-8 py-4 rounded-lg font-bold text-lg">
                        ‚ñ∂Ô∏è Start Reset
                    </button>
                    <button onclick="stopBreathingReset()" id="stopBreathingBtn" 
                            class="bg-red-600 text-white px-8 py-4 rounded-lg font-bold text-lg" disabled>
                        ‚èπÔ∏è Stop
                    </button>
                </div>
                
                <!-- Current Phase -->
                <div class="text-center">
                    <div class="text-sm text-gray-400">Current Phase:</div>
                    <div class="text-lg font-bold text-white" id="currentBreathingPhase">Preparation</div>
                </div>
            </div>

            <!-- Motivational Messages -->
            <div class="card">
                <h3 class="text-xl font-bold text-accent mb-4">üí™ Motivational Messages</h3>
                <div class="text-center mb-4">
                    <div class="text-lg text-gray-300 italic mb-4" id="currentMotivation">
                        "Take a deep breath. You have the strength to handle whatever comes your way."
                    </div>
                    <button onclick="getNewMotivation()" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-bold">
                        üîÑ New Message
                    </button>
                </div>
                
                <!-- Add Custom Messages -->
                <div class="mt-6">
                    <h4 class="text-white font-bold mb-3">Add Your Own Messages:</h4>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="newMotivationalMessage" placeholder="Enter motivational message..." 
                               class="flex-1 p-3 rounded-lg bg-gray-800 border border-accent text-white">
                        <button onclick="addMotivationalMessage()" class="bg-green-600 text-white px-4 py-3 rounded-lg font-bold">
                            Add
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div id="addContactModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-accent">‚ûï Add New Contact</h3>
                <button onclick="closeAddContact()" class="text-gray-400 hover:text-white text-2xl">‚úï</button>
            </div>
            
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white font-semibold mb-2">Name *</label>
                        <input type="text" id="contactName" placeholder="Full name" 
                               class="w-full p-3 rounded-lg bg-gray-800 border border-accent text-white">
                    </div>
                    <div>
                        <label class="block text-white font-semibold mb-2">Relationship Tier *</label>
                        <select id="contactTier" class="w-full p-3 rounded-lg bg-gray-800 border border-accent text-white">
                            <option value="inner">Inner Circle (Daily/Weekly)</option>
                            <option value="close">Close Friends (Weekly/Bi-weekly)</option>
                            <option value="regular">Regular Contact (Monthly)</option>
                            <option value="occasional">Occasional (Quarterly)</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-white font-semibold mb-2">Connection Cadence (days)</label>
                    <select id="contactCadence" class="w-full p-3 rounded-lg bg-gray-800 border border-accent text-white">
                        <option value="1">Daily</option>
                        <option value="3">Every 3 days</option>
                        <option value="7">Weekly</option>
                        <option value="14">Bi-weekly</option>
                        <option value="30">Monthly</option>
                        <option value="90">Quarterly</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-white font-semibold mb-2">Notes & Memory Aids</label>
                    <button onclick="startVoiceInput('contactNotes', this)" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm mb-2">
                        üé§ Voice
                    </button>
                    <textarea id="contactNotes" placeholder="Important details, interests, family info, conversation topics..." 
                              class="w-full h-24 p-3 rounded-lg bg-gray-800 border border-accent text-white resize-none"></textarea>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="saveContact()" class="bg-accent text-black px-6 py-3 rounded-lg font-bold flex-1">
                        üíæ Save Contact
                    </button>
                    <button onclick="closeAddContact()" class="bg-gray-600 text-white px-6 py-3 rounded-lg font-bold">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Add Modal -->
    <div id="quickAddModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-accent">‚ö° Quick Add</h3>
                <button onclick="closeQuickAdd()" class="text-gray-400 hover:text-white text-2xl">‚úï</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-white font-semibold mb-2">What would you like to add?</label>
                    <select id="quickAddType" onchange="updateQuickAddForm()" class="w-full p-3 rounded-lg bg-gray-800 border border-accent text-white">
                        <option value="connection">üìû Log Connection</option>
                        <option value="note">üìù Add Note</option>
                    </select>
                </div>
                
                <div id="quickAddForm">
                    <!-- Form will be populated based on selection -->
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="saveQuickAdd()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex-1">
                        üíæ Save
                    </button>
                    <button onclick="closeQuickAdd()" class="bg-gray-600 text-white px-6 py-3 rounded-lg font-bold">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let appData = {
            contacts: [],
            connections: [],
            repairs: [],
            vocabulary: {
                empathy: [
                    "I can see this is really important to you",
                    "Help me understand your perspective",
                    "That sounds really difficult",
                    "I hear what you're saying",
                    "Your feelings are completely valid"
                ],
                boundaries: [
                    "I need some time to think about this",
                    "I'm not comfortable with that",
                    "Let's find a solution that works for both of us",
                    "I value our relationship and need to be honest",
                    "I can't do that, but here's what I can do"
                ],
                repair: [
                    "I take full responsibility for my part in this",
                    "I'm sorry for how my actions affected you",
                    "What can I do to make this right?",
                    "I value our relationship and want to repair this",
                    "Help me understand how to do better"
                ],
                connection: [
                    "I've been thinking about you",
                    "I appreciate you so much",
                    "Thank you for being such a good friend",
                    "I'm grateful to have you in my life",
                    "You mean a lot to me"
                ]
            },
            motivationalMessages: [
                "Take a deep breath. You have the strength to handle whatever comes your way.",
                "Every breath is a new opportunity to reset and refocus.",
                "You are capable of creating positive change in your relationships.",
                "Breathe in peace, breathe out tension. You've got this.",
                "This moment of calm will help you respond with wisdom and love."
            ],
            streaks: {
                connection: 0,
                longestConnection: 0
            }
        };

        // Voice recognition
        let recognition = null;
        let isListening = false;
        let currentVoiceTarget = null;
        let voiceButton = null;

        // Breathing reset variables
        let breathingTimer = null;
        let breathingInterval = null;
        let breathingSeconds = 0;
        let breathingDuration = 1500; // 25 minutes
        let isBreathingActive = false;

        // Repair session variables
        let currentRepairSession = null;
        let repairSteps = [
            { id: 'pause', name: 'Pause & Breathe', description: 'Take a moment to center yourself before responding' },
            { id: 'reflect', name: 'Reflect on Your Part', description: 'Consider your role in the situation without blame' },
            { id: 'own', name: 'Own Your Actions', description: 'Take responsibility for your part in the conflict' },
            { id: 'ask', name: 'Ask & Listen', description: 'Ask for their perspective and truly listen' },
            { id: 'next', name: 'Plan Next Steps', description: 'Agree on how to move forward together' }
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadAppData();
            updateAllStats();
            initializeSpeechRecognition();
            loadContacts();
            loadReminders();
            loadVocabulary();
            loadRepairHistory();
            populateContactSelects();
            checkReminders();
            
            // Set up reminder checking
            setInterval(checkReminders, 60000); // Check every minute
        });

        // Data Management
        function loadAppData() {
            const savedData = localStorage.getItem('relationshipAppData');
            if (savedData) {
                const data = JSON.parse(savedData);
                appData = { ...appData, ...data };
            }
            calculateStreaks();
        }

        function saveAppData() {
            localStorage.setItem('relationshipAppData', JSON.stringify(appData));
        }

        // Screen Management
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(screenName + 'Screen').classList.remove('hidden');
            document.getElementById(screenName + 'Btn').classList.add('active');
            
            // Load screen-specific data
            switch(screenName) {
                case 'contacts': 
                    loadContacts();
                    break;
                case 'reminders': 
                    loadReminders();
                    break;
                case 'repair':
                    loadRepairHistory();
                    populateRepairContacts();
                    break;
                case 'vocabulary': 
                    loadVocabulary();
                    populateCallContacts();
                    break;
            }
        }

        // Contact Management
        function showAddContact() {
            document.getElementById('addContactModal').classList.remove('hidden');
        }

        function closeAddContact() {
            document.getElementById('addContactModal').classList.add('hidden');
            clearContactForm();
        }

        function clearContactForm() {
            document.getElementById('contactName').value = '';
            document.getElementById('contactTier').value = 'close';
            document.getElementById('contactCadence').value = '7';
            document.getElementById('contactNotes').value = '';
        }

        function saveContact() {
            const name = document.getElementById('contactName').value.trim();
            const tier = document.getElementById('contactTier').value;
            const cadence = parseInt(document.getElementById('contactCadence').value);
            const notes = document.getElementById('contactNotes').value.trim();
            
            if (!name) {
                showNotification('Please enter a contact name');
                return;
            }
            
            const contact = {
                id: Date.now().toString(),
                name: name,
                tier: tier,
                cadence: cadence,
                notes: notes,
                lastContact: null,
                nextContact: new Date(Date.now() + cadence * 24 * 60 * 60 * 1000).toISOString(),
                created: new Date().toISOString(),
                connectionCount: 0
            };
            
            appData.contacts.push(contact);
            saveAppData();
            updateAllStats();
            loadContacts();
            populateContactSelects();
            closeAddContact();
            
            showNotification(`üë§ ${name} added to your contacts!`);
        }

        function loadContacts() {
            const container = document.getElementById('contactsList');
            
            if (appData.contacts.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <div class="text-4xl mb-4">üë•</div>
                        <h3 class="text-lg font-bold mb-2">No contacts yet</h3>
                        <p>Add your first contact to start building stronger relationships</p>
                    </div>
                `;
                return;
            }
            
            let filteredContacts = [...appData.contacts];
            
            // Apply search filter
            const searchFilter = document.getElementById('contactSearch')?.value.toLowerCase();
            if (searchFilter) {
                filteredContacts = filteredContacts.filter(c => 
                    c.name.toLowerCase().includes(searchFilter) ||
                    c.notes.toLowerCase().includes(searchFilter)
                );
            }
            
            // Sort by next contact date
            filteredContacts.sort((a, b) => {
                if (!a.nextContact) return 1;
                if (!b.nextContact) return -1;
                return new Date(a.nextContact) - new Date(b.nextContact);
            });
            
            container.innerHTML = filteredContacts.map(contact => {
                const status = getContactStatus(contact);
                const statusClass = status === 'overdue' ? 'overdue' : status === 'due-soon' ? 'due-soon' : '';
                const nextContactDate = contact.nextContact ? new Date(contact.nextContact).toLocaleDateString() : 'Not set';
                const daysSinceContact = contact.lastContact ? 
                    Math.floor((Date.now() - new Date(contact.lastContact)) / (1000 * 60 * 60 * 24)) : 
                    'Never';
                
                return `
                    <div class="contact-card ${statusClass}">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-white mb-1">${contact.name}</h3>
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="tier-chip tier-${contact.tier}">${getTierName(contact.tier)}</span>
                                    <span class="text-xs text-gray-400">Every ${contact.cadence} days</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <button onclick="logConnection('${contact.id}')" 
                                        class="bg-green-600 text-white px-3 py-1 rounded text-sm font-bold mb-1">
                                    üìû Connect
                                </button>
                                <div class="text-xs text-gray-400">
                                    Next: ${nextContactDate}
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-400">Last contact:</span>
                                <span class="text-white">${daysSinceContact === 'Never' ? 'Never' : daysSinceContact + ' days ago'}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Total connections:</span>
                                <span class="text-white">${contact.connectionCount}</span>
                            </div>
                        </div>
                        
                        ${contact.notes ? `
                            <div class="mt-3 text-sm text-gray-300">
                                <strong>Notes:</strong> ${contact.notes.substring(0, 100)}${contact.notes.length > 100 ? '...' : ''}
                            </div>
                        ` : ''}
                        
                        <div class="mt-3 flex gap-2">
                            <button onclick="editContact('${contact.id}')" class="bg-blue-600 text-white px-2 py-1 rounded text-xs">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="deleteContact('${contact.id}')" class="bg-red-600 text-white px-2 py-1 rounded text-xs">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterContacts() {
            loadContacts();
        }

        function getContactStatus(contact) {
            if (!contact.nextContact) return 'current';
            
            const nextDate = new Date(contact.nextContact);
            const now = new Date();
            const diffDays = Math.ceil((nextDate - now) / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return 'overdue';
            if (diffDays <= 2) return 'due-soon';
            return 'current';
        }

        function getTierName(tier) {
            const names = {
                inner: 'Inner Circle',
                close: 'Close Friends',
                regular: 'Regular',
                occasional: 'Occasional'
            };
            return names[tier] || tier;
        }

        function logConnection(contactId) {
            const contact = appData.contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            const connectionType = prompt(`How did you connect with ${contact.name}?\n\n1. Phone call\n2. Text message\n3. In person\n4. Video call\n5. Email\n\nEnter number (1-5):`);
            
            const types = {
                '1': 'Phone call',
                '2': 'Text message', 
                '3': 'In person',
                '4': 'Video call',
                '5': 'Email'
            };
            
            if (!types[connectionType]) return;
            
            const notes = prompt('Any notes about this connection? (optional)') || '';
            
            const connection = {
                id: Date.now().toString(),
                contactId: contactId,
                date: new Date().toISOString(),
                type: types[connectionType],
                notes: notes
            };
            
            appData.connections.push(connection);
            
            // Update contact
            contact.lastContact = new Date().toISOString();
            contact.nextContact = new Date(Date.now() + contact.cadence * 24 * 60 * 60 * 1000).toISOString();
            contact.connectionCount++;
            
            // Update streak
            updateConnectionStreak();
            
            saveAppData();
            updateAllStats();
            loadContacts();
            loadReminders();
            
            showNotification(`üìû Connection with ${contact.name} logged!`);
        }

        function editContact(contactId) {
            const contact = appData.contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            // Populate form with existing data
            document.getElementById('contactName').value = contact.name;
            document.getElementById('contactTier').value = contact.tier;
            document.getElementById('contactCadence').value = contact.cadence;
            document.getElementById('contactNotes').value = contact.notes;
            
            // Remove the contact temporarily
            appData.contacts = appData.contacts.filter(c => c.id !== contactId);
            
            showAddContact();
        }

        function deleteContact(contactId) {
            const contact = appData.contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            if (confirm(`Delete ${contact.name} from your contacts? This cannot be undone.`)) {
                appData.contacts = appData.contacts.filter(c => c.id !== contactId);
                appData.connections = appData.connections.filter(c => c.contactId !== contactId);
                
                saveAppData();
                updateAllStats();
                loadContacts();
                
                showNotification(`üóëÔ∏è ${contact.name} deleted from contacts`);
            }
        }

        // Reminders Management
        function loadReminders() {
            loadTodayReminders();
            loadOverdueReminders();
            loadRecentConnections();
        }

        function loadTodayReminders() {
            const container = document.getElementById('todayReminders');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const todayContacts = appData.contacts.filter(contact => {
                if (!contact.nextContact) return false;
                const nextDate = new Date(contact.nextContact);
                return nextDate >= today && nextDate < tomorrow;
            });
            
            if (todayContacts.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center">No connections scheduled for today</div>';
                return;
            }
            
            container.innerHTML = todayContacts.map(contact => `
                <div class="contact-card">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="text-white font-bold">${contact.name}</h4>
                            <div class="text-sm text-gray-400">${getTierName(contact.tier)} ‚Ä¢ Every ${contact.cadence} days</div>
                        </div>
                        <button onclick="logConnection('${contact.id}')" class="bg-green-600 text-white px-4 py-2 rounded font-bold">
                            üìû Connect
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function loadOverdueReminders() {
            const container = document.getElementById('overdueReminders');
            const today = new Date();
            
            const overdueContacts = appData.contacts.filter(contact => {
                if (!contact.nextContact) return false;
                return new Date(contact.nextContact) < today;
            }).sort((a, b) => new Date(a.nextContact) - new Date(b.nextContact));
            
            if (overdueContacts.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center">No overdue connections! üéâ</div>';
                return;
            }
            
            container.innerHTML = overdueContacts.map(contact => {
                const daysPast = Math.floor((today - new Date(contact.nextContact)) / (1000 * 60 * 60 * 24));
                return `
                    <div class="contact-card overdue">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="text-white font-bold">${contact.name}</h4>
                                <div class="text-sm text-red-400">${daysPast} days overdue ‚Ä¢ ${getTierName(contact.tier)}</div>
                            </div>
                            <button onclick="logConnection('${contact.id}')" class="bg-red-600 text-white px-4 py-2 rounded font-bold">
                                üìû Connect Now
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadRecentConnections() {
            const container = document.getElementById('recentConnections');
            const recentConnections = appData.connections
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);
            
            if (recentConnections.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center">No connections logged yet</div>';
                return;
            }
            
            container.innerHTML = recentConnections.map(connection => {
                const contact = appData.contacts.find(c => c.id === connection.contactId);
                if (!contact) return '';
                
                return `
                    <div class="bg-gray-800 p-3 rounded">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-white font-bold">${contact.name}</h4>
                                <div class="text-sm text-gray-400">${connection.type} ‚Ä¢ ${new Date(connection.date).toLocaleDateString()}</div>
                                ${connection.notes ? `<div class="text-xs text-gray-300 mt-1">${connection.notes}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function checkReminders() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const todayContacts = appData.contacts.filter(contact => {
                if (!contact.nextContact) return false;
                const nextDate = new Date(contact.nextContact);
                return nextDate >= today && nextDate < tomorrow;
            });
            
            const overdueContacts = appData.contacts.filter(contact => {
                if (!contact.nextContact) return false;
                return new Date(contact.nextContact) < today;
            });
            
            // Update header stats
            document.getElementById('overdueContacts').textContent = overdueContacts.length;
        }

        // Repair Playbook
        function populateRepairContacts() {
            const select = document.getElementById('repairContact');
            select.innerHTML = '<option value="">Choose contact...</option>';
            
            appData.contacts.forEach(contact => {
                select.innerHTML += `<option value="${contact.id}">${contact.name}</option>`;
            });
        }

        function startRepairSession() {
            const contactId = document.getElementById('repairContact').value;
            const issueType = document.getElementById('issueType').value;
            const description = document.getElementById('issueDescription').value.trim();
            
            if (!contactId) {
                showNotification('Please select a contact');
                return;
            }
            
            if (!description) {
                showNotification('Please describe the issue');
                return;
            }
            
            const contact = appData.contacts.find(c => c.id === contactId);
            
            currentRepairSession = {
                id: Date.now().toString(),
                contactId: contactId,
                contactName: contact.name,
                issueType: issueType,
                description: description,
                startDate: new Date().toISOString(),
                steps: repairSteps.map(step => ({ ...step, completed: false, notes: '' })),
                currentStep: 0
            };
            
            document.getElementById('repairContactName').textContent = contact.name;
            document.getElementById('repairIssue').textContent = description;
            
            loadRepairSteps();
            
            document.getElementById('newRepair').classList.add('hidden');
            document.getElementById('activeRepair').classList.remove('hidden');
            
            showNotification('üîß Repair session started. Take your time with each step.');
        }

        function loadRepairSteps() {
            const container = document.getElementById('repairSteps');
            
            container.innerHTML = currentRepairSession.steps.map((step, index) => `
                <div class="repair-step ${step.completed ? 'completed' : ''}" id="step-${step.id}">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="text-white font-bold mb-1">${index + 1}. ${step.name}</h4>
                            <p class="text-gray-300 text-sm">${step.description}</p>
                        </div>
                        <button onclick="toggleRepairStep('${step.id}')" 
                                class="px-3 py-1 rounded text-sm font-bold ${step.completed ? 'bg-green-600 text-white' : 'bg-gray-600 text-white'}">
                            ${step.completed ? '‚úÖ Done' : '‚≠ï Mark Done'}
                        </button>
                    </div>
                    
                    <div class="mt-3">
                        <label class="block text-white font-semibold mb-2 text-sm">Notes for this step:</label>
                        <button onclick="startVoiceInput('step-notes-${step.id}', this)" 
                                class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold mb-2">
                            üé§ Voice
                        </button>
                        <textarea id="step-notes-${step.id}" placeholder="Your thoughts, actions taken, insights..." 
                                  class="w-full h-16 p-2 rounded bg-gray-800 border border-accent text-white text-sm resize-none">${step.notes}</textarea>
                    </div>
                </div>
            `).join('');
        }

        function toggleRepairStep(stepId) {
            const step = currentRepairSession.steps.find(s => s.id === stepId);
            if (!step) return;
            
            // Save notes before toggling
            const notesElement = document.getElementById(`step-notes-${stepId}`);
            if (notesElement) {
                step.notes = notesElement.value;
            }
            
            step.completed = !step.completed;
            
            loadRepairSteps();
            
            if (step.completed) {
                showNotification(`‚úÖ Step "${step.name}" completed`);
            }
        }

        function completeRepairSession() {
            // Save all step notes
            currentRepairSession.steps.forEach(step => {
                const notesElement = document.getElementById(`step-notes-${step.id}`);
                if (notesElement) {
                    step.notes = notesElement.value;
                }
            });
            
            currentRepairSession.endDate = new Date().toISOString();
            currentRepairSession.completed = true;
            
            appData.repairs.push(currentRepairSession);
            
            saveAppData();
            updateAllStats();
            loadRepairHistory();
            
            endRepairSession();
            
            showNotification('üåü Repair session completed! Great work on strengthening your relationship.');
        }

        function endRepairSession() {
            currentRepairSession = null;
            
            document.getElementById('activeRepair').classList.add('hidden');
            document.getElementById('newRepair').classList.remove('hidden');
            
            // Clear form
            document.getElementById('repairContact').value = '';
            document.getElementById('issueType').value = 'misunderstanding';
            document.getElementById('issueDescription').value = '';
        }

        function loadRepairHistory() {
            const container = document.getElementById('repairHistory');
            const recentRepairs = appData.repairs
                .sort((a, b) => new Date(b.startDate) - new Date(a.startDate))
                .slice(0, 10);
            
            if (recentRepairs.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center">No repair sessions yet</div>';
                return;
            }
            
            container.innerHTML = recentRepairs.map(repair => {
                const completedSteps = repair.steps.filter(s => s.completed).length;
                const totalSteps = repair.steps.length;
                
                return `
                    <div class="bg-gray-800 p-3 rounded">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="text-white font-bold">${repair.contactName}</h4>
                                <div class="text-sm text-gray-400">${repair.issueType} ‚Ä¢ ${new Date(repair.startDate).toLocaleDateString()}</div>
                                <div class="text-xs text-gray-300 mt-1">${repair.description}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm ${repair.completed ? 'text-green-400' : 'text-yellow-400'}">
                                    ${repair.completed ? '‚úÖ Completed' : 'üîÑ In Progress'}
                                </div>
                                <div class="text-xs text-gray-400">${completedSteps}/${totalSteps} steps</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Voice Recognition
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        }
                    }
                    
                    if (finalTranscript && currentVoiceTarget) {
                        const currentText = currentVoiceTarget.value;
                        const newText = currentText ? currentText + ' ' + finalTranscript : finalTranscript;
                        currentVoiceTarget.value = newText;
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    stopVoiceInput();
                    showNotification('Voice recognition error. Please try again.');
                };
                
                recognition.onend = function() {
                    if (isListening) {
                        stopVoiceInput();
                    }
                };
            }
        }

        function startVoiceInput(targetElementId, buttonElement) {
            if (!recognition) {
                showNotification('Voice recognition not supported in this browser');
                return;
            }
            
            if (isListening) {
                stopVoiceInput();
                return;
            }
            
            currentVoiceTarget = document.getElementById(targetElementId);
            voiceButton = buttonElement;
            
            if (!currentVoiceTarget) {
                showNotification('Target element not found');
                return;
            }
            
            try {
                recognition.start();
                isListening = true;
                
                // Update button appearance
                voiceButton.innerHTML = '‚èπÔ∏è Stop';
                voiceButton.classList.remove('bg-blue-600');
                voiceButton.classList.add('bg-red-600');
                
                // Add visual feedback to target input
                currentVoiceTarget.classList.add('voice-listening');
                
                showNotification('üé§ Listening... Speak clearly into your microphone');
            } catch (error) {
                console.error('Failed to start voice recognition:', error);
                showNotification('Failed to start voice recognition');
                stopVoiceInput();
            }
        }

        function stopVoiceInput() {
            if (recognition && isListening) {
                recognition.stop();
            }
            
            isListening = false;
            
            if (voiceButton) {
                voiceButton.innerHTML = 'üé§ Voice';
                voiceButton.classList.remove('bg-red-600');
                voiceButton.classList.add('bg-blue-600');
            }
            
            if (currentVoiceTarget) {
                currentVoiceTarget.classList.remove('voice-listening');
            }
            
            currentVoiceTarget = null;
            voiceButton = null;
        }

        // Vocabulary Management
        function loadVocabulary() {
            loadEmpathyPhrases();
            loadBoundaryPhrases();
            loadRepairPhrases();
            loadConnectionPhrases();
        }

        function loadEmpathyPhrases() {
            const container = document.getElementById('empathyPhrases');
            container.innerHTML = appData.vocabulary.empathy.map((phrase, index) => `
                <div class="phrase-card" onclick="copyToClipboard('${phrase}')">
                    <div class="flex justify-between items-center">
                        <span class="text-white text-sm flex-1">${phrase}</span>
                        <button onclick="event.stopPropagation(); removePhrase('empathy', ${index})" class="text-red-400 text-xs ml-2">‚úï</button>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">Click to copy</div>
                </div>
            `).join('');
        }

        function loadBoundaryPhrases() {
            const container = document.getElementById('boundaryPhrases');
            container.innerHTML = appData.vocabulary.boundaries.map((phrase, index) => `
                <div class="phrase-card" onclick="copyToClipboard('${phrase}')">
                    <div class="flex justify-between items-center">
                        <span class="text-white text-sm flex-1">${phrase}</span>
                        <button onclick="event.stopPropagation(); removePhrase('boundaries', ${index})" class="text-red-400 text-xs ml-2">‚úï</button>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">Click to copy</div>
                </div>
            `).join('');
        }

        function loadRepairPhrases() {
            const container = document.getElementById('repairPhrases');
            container.innerHTML = appData.vocabulary.repair.map((phrase, index) => `
                <div class="phrase-card" onclick="copyToClipboard('${phrase}')">
                    <div class="flex justify-between items-center">
                        <span class="text-white text-sm flex-1">${phrase}</span>
                        <button onclick="event.stopPropagation(); removePhrase('repair', ${index})" class="text-red-400 text-xs ml-2">‚úï</button>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">Click to copy</div>
                </div>
            `).join('');
        }

        function loadConnectionPhrases() {
            const container = document.getElementById('connectionPhrases');
            container.innerHTML = appData.vocabulary.connection.map((phrase, index) => `
                <div class="phrase-card" onclick="copyToClipboard('${phrase}')">
                    <div class="flex justify-between items-center">
                        <span class="text-white text-sm flex-1">${phrase}</span>
                        <button onclick="event.stopPropagation(); removePhrase('connection', ${index})" class="text-red-400 text-xs ml-2">‚úï</button>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">Click to copy</div>
                </div>
            `).join('');
        }

        function addEmpathyPhrase() {
            const phrase = document.getElementById('newEmpathyPhrase').value.trim();
            if (phrase) {
                appData.vocabulary.empathy.push(phrase);
                document.getElementById('newEmpathyPhrase').value = '';
                saveAppData();
                loadEmpathyPhrases();
                showNotification('‚ù§Ô∏è Empathy phrase added!');
            }
        }

        function addBoundaryPhrase() {
            const phrase = document.getElementById('newBoundaryPhrase').value.trim();
            if (phrase) {
                appData.vocabulary.boundaries.push(phrase);
                document.getElementById('newBoundaryPhrase').value = '';
                saveAppData();
                loadBoundaryPhrases();
                showNotification('üõ°Ô∏è Boundary phrase added!');
            }
        }

        function addRepairPhrase() {
            const phrase = document.getElementById('newRepairPhrase').value.trim();
            if (phrase) {
                appData.vocabulary.repair.push(phrase);
                document.getElementById('newRepairPhrase').value = '';
                saveAppData();
                loadRepairPhrases();
                showNotification('üîß Repair phrase added!');
            }
        }

        function addConnectionPhrase() {
            const phrase = document.getElementById('newConnectionPhrase').value.trim();
            if (phrase) {
                appData.vocabulary.connection.push(phrase);
                document.getElementById('newConnectionPhrase').value = '';
                saveAppData();
                loadConnectionPhrases();
                showNotification('ü§ù Connection phrase added!');
            }
        }

        function removePhrase(category, index) {
            if (confirm('Remove this phrase?')) {
                appData.vocabulary[category].splice(index, 1);
                saveAppData();
                loadVocabulary();
                showNotification('Phrase removed');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('üìã Copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('üìã Copied to clipboard!');
            });
        }

        // Call Notes
        function populateCallContacts() {
            const select = document.getElementById('callContact');
            select.innerHTML = '<option value="">Select contact...</option>';
            
            appData.contacts.forEach(contact => {
                select.innerHTML += `<option value="${contact.id}">${contact.name}</option>`;
            });
        }

        function saveCallNotes() {
            const contactId = document.getElementById('callContact').value;
            const callType = document.getElementById('callType').value;
            const notes = document.getElementById('callNotes').value.trim();
            
            if (!contactId) {
                showNotification('Please select a contact');
                return;
            }
            
            if (!notes) {
                showNotification('Please add some notes');
                return;
            }
            
            const contact = appData.contacts.find(c => c.id === contactId);
            
            // Log as a connection
            const connection = {
                id: Date.now().toString(),
                contactId: contactId,
                date: new Date().toISOString(),
                type: callType === 'check-in' ? 'Phone call' : callType,
                notes: notes
            };
            
            appData.connections.push(connection);
            
            // Update contact
            contact.lastContact = new Date().toISOString();
            contact.nextContact = new Date(Date.now() + contact.cadence * 24 * 60 * 60 * 1000).toISOString();
            contact.connectionCount++;
            
            saveAppData();
            updateAllStats();
            
            // Clear form
            document.getElementById('callContact').value = '';
            document.getElementById('callType').value = 'check-in';
            document.getElementById('callNotes').value = '';
            
            showNotification(`üìû Call notes saved for ${contact.name}!`);
        }

        // Breathing Reset
        function startBreathingReset() {
            breathingSeconds = breathingDuration;
            isBreathingActive = true;
            
            document.getElementById('startBreathingBtn').disabled = true;
            document.getElementById('stopBreathingBtn').disabled = false;
            document.getElementById('breathingInstruction').textContent = 'Focus on your breath and let go of tension';
            
            updateBreathingDisplay();
            startBreathingAnimation();
            
            breathingTimer = setInterval(() => {
                breathingSeconds--;
                updateBreathingDisplay();
                
                if (breathingSeconds <= 0) {
                    completeBreathingReset();
                }
            }, 1000);
            
            showNotification('üå¨Ô∏è Breathing reset started. Take deep, calming breaths.');
        }

        function stopBreathingReset() {
            if (breathingTimer) {
                clearInterval(breathingTimer);
                clearInterval(breathingInterval);
                breathingTimer = null;
                breathingInterval = null;
            }
            
            isBreathingActive = false;
            
            document.getElementById('startBreathingBtn').disabled = false;
            document.getElementById('stopBreathingBtn').disabled = true;
            document.getElementById('breathingInstruction').textContent = 'Prepare for your breathing reset session';
            
            const circle = document.getElementById('breathingCircle');
            circle.classList.remove('inhale', 'exhale');
            document.getElementById('breathingCue').textContent = 'Ready';
            
            breathingSeconds = breathingDuration;
            updateBreathingDisplay();
            
            showNotification('‚èπÔ∏è Breathing reset stopped');
        }

        function completeBreathingReset() {
            clearInterval(breathingTimer);
            clearInterval(breathingInterval);
            
            // Reset UI
            stopBreathingReset();
            
            // Show completion message
            showNotification('üåü 25-minute breathing reset completed! You\'re centered and ready.');
        }

        function startBreathingAnimation() {
            const circle = document.getElementById('breathingCircle');
            const cue = document.getElementById('breathingCue');
            let breathingPhase = 'inhale';
            
            breathingInterval = setInterval(() => {
                if (breathingPhase === 'inhale') {
                    circle.classList.add('inhale');
                    circle.classList.remove('exhale');
                    cue.textContent = 'Inhale';
                    breathingPhase = 'exhale';
                } else {
                    circle.classList.add('exhale');
                    circle.classList.remove('inhale');
                    cue.textContent = 'Exhale';
                    breathingPhase = 'inhale';
                }
            }, 4000);
        }

        function updateBreathingDisplay() {
            const minutes = Math.floor(breathingSeconds / 60);
            const seconds = breathingSeconds % 60;
            document.getElementById('breathingTimer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function getNewMotivation() {
            const messages = [...appData.motivationalMessages];
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            document.getElementById('currentMotivation').textContent = `"${randomMessage}"`;
        }

        function addMotivationalMessage() {
            const message = document.getElementById('newMotivationalMessage').value.trim();
            if (message) {
                appData.motivationalMessages.push(message);
                document.getElementById('newMotivationalMessage').value = '';
                saveAppData();
                showNotification('üí™ Motivational message added!');
            }
        }

        // Quick Add
        function showQuickAdd() {
            document.getElementById('quickAddModal').classList.remove('hidden');
            updateQuickAddForm();
        }

        function closeQuickAdd() {
            document.getElementById('quickAddModal').classList.add('hidden');
        }

        function updateQuickAddForm() {
            const type = document.getElementById('quickAddType').value;
            const container = document.getElementById('quickAddForm');
            
            if (type === 'connection') {
                container.innerHTML = `
                    <div>
                        <label class="block text-white font-semibold mb-2">Contact</label>
                        <select id="quickContact" class="w-full p-3 rounded-lg bg-gray-800 border border-accent text-white">
                            <option value="">Select contact...</option>
                            ${appData.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-white font-semibold mb-2">Connection Type</label>
                        <select id="quickConnectionType" class="w-full p-3 rounded-lg bg-gray-800 border border-accent text-white">
                            <option value="Phone call">Phone call</option>
                            <option value="Text message">Text message</option>
                            <option value="In person">In person</option>
                            <option value="Video call">Video call</option>
                            <option value="Email">Email</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-white font-semibold mb-2">Notes (optional)</label>
                        <button onclick="startVoiceInput('quickNotes', this)" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm mb-2">
                            üé§ Voice
                        </button>
                        <textarea id="quickNotes" placeholder="Any notes about this connection..." 
                                  class="w-full h-20 p-3 rounded-lg bg-gray-800 border border-accent text-white resize-none"></textarea>
                    </div>
                `;
            } else if (type === 'note') {
                container.innerHTML = `
                    <div>
                        <label class="block text-white font-semibold mb-2">Contact (optional)</label>
                        <select id="quickNoteContact" class="w-full p-3 rounded-lg bg-gray-800 border border-accent text-white">
                            <option value="">General note</option>
                            ${appData.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-white font-semibold mb-2">Note</label>
                        <button onclick="startVoiceInput('quickNoteText', this)" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm mb-2">
                            üé§ Voice
                        </button>
                        <textarea id="quickNoteText" placeholder="Your note..." 
                                  class="w-full h-24 p-3 rounded-lg bg-gray-800 border border-accent text-white resize-none"></textarea>
                    </div>
                `;
            }
        }

        function saveQuickAdd() {
            const type = document.getElementById('quickAddType').value;
            
            if (type === 'connection') {
                const contactId = document.getElementById('quickContact').value;
                const connectionType = document.getElementById('quickConnectionType').value;
                const notes = document.getElementById('quickNotes').value.trim();
                
                if (!contactId) {
                    showNotification('Please select a contact');
                    return;
                }
                
                const contact = appData.contacts.find(c => c.id === contactId);
                
                const connection = {
                    id: Date.now().toString(),
                    contactId: contactId,
                    date: new Date().toISOString(),
                    type: connectionType,
                    notes: notes
                };
                
                appData.connections.push(connection);
                
                // Update contact
                contact.lastContact = new Date().toISOString();
                contact.nextContact = new Date(Date.now() + contact.cadence * 24 * 60 * 60 * 1000).toISOString();
                contact.connectionCount++;
                
                updateConnectionStreak();
                saveAppData();
                updateAllStats();
                
                showNotification(`üìû Connection with ${contact.name} logged!`);
                
            } else if (type === 'note') {
                const noteText = document.getElementById('quickNoteText').value.trim();
                
                if (!noteText) {
                    showNotification('Please enter a note');
                    return;
                }
                
                // For simplicity, we'll just show a success message
                // In a full app, you'd save this to a notes array
                showNotification('üìù Note saved!');
            }
            
            closeQuickAdd();
        }

        // Streak Calculations
        function calculateStreaks() {
            calculateConnectionStreak();
        }

        function calculateConnectionStreak() {
            const today = new Date();
            let streak = 0;
            let currentDate = new Date(today);
            
            while (true) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const hasConnection = appData.connections.some(c => c.date.split('T')[0] === dateStr);
                
                if (hasConnection) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            appData.streaks.connection = streak;
            if (streak > appData.streaks.longestConnection) {
                appData.streaks.longestConnection = streak;
            }
        }

        function updateConnectionStreak() {
            calculateConnectionStreak();
        }

        // Stats Updates
        function updateAllStats() {
            document.getElementById('connectionStreak').textContent = appData.streaks.connection;
            document.getElementById('totalContacts').textContent = appData.contacts.length;
            
            const overdueCount = appData.contacts.filter(contact => {
                if (!contact.nextContact) return false;
                return new Date(contact.nextContact) < new Date();
            }).length;
            
            document.getElementById('overdueContacts').textContent = overdueCount;
        }

        function populateContactSelects() {
            populateRepairContacts();
            populateCallContacts();
        }

        // Notifications
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9883cde1f64db9f0',t:'MTc1OTQwMzk2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

